---
title: "仮想マシン作成:UTokyo Azure 利用例"
---

## 概要

本サービスで多く利用されると思われる，仮想マシン（Azure のサービス名はVirtual Machines）の作成手順の一例です．

## サービスを選択する

- [Azure portal](https://potral.azure.com/)にUTokyo Accountでログインし、Azureサービスの一覧の中から「Virtual Machines」を選択する。
    - 一覧に無い場合、一覧の右にある「その他のサービス」を選択、左側にあるリストから「コンピューティング」を選択すると，右側に表示されるメイン画面の「Infrastructure as a Service(IaaS)」の中にあります．
- Virtual Machines のメインページが表示されたら，「＋作成」をクリックします．
- 選択肢が出てきますが，以下は「Azure仮想マシン」を選択したものとして進めます．

## 仮想マシンを構成する

仮想マシンの構成を指定します。

### 基本パート

#### プロジェクトの詳細

- **サブスクリプション**：事前に申請したサブスクリプションがすでに設定されています．
- **リソースグループ**：仮想マシンはリソース毎に管理されるため，同じポリシーで構成されるリソースはリソースグループで一括管理します．わかりやすい名称を入力してください．

#### インスタンスの詳細

- **仮想マシン名**：Azure Portal 内で管理される仮想マシン名称です．わかりやすい名称を入力してくだささい．
- **リージョン**：仮想マシンをどの地域にあるデータセンターにデプロイするかを指定します．特段の理由がなければJapan EastやJapan Westを選択ください．
- **可用性オプション**：希望する冗長構成を選択してください．
- **ゾーンオプション**：基本は自己選択ゾーンで問題ありません．
- **可用性ゾーン**：複数のゾーンに仮想マシンの冗長機を構成したい場合はどのゾーンに構成するかを選択ください．
- **セキュリティの種類**：ご自身の用途に応じて，セキュリティレベルを選択してください．
- **イメージ**：デプロイしたいＯＳを選択してください．
- **VMアーキテクチャ**：x86かARMを選択できます．特段の理由がなければx86を選択いただくのが無難です．
- **Azure Spot 割引で実行する**：利用頻度が減った時にAzureから資源の回収対象となり、停止や削除をされる可能性があるかわりに割安になります．止められたくない場合はチェックは入れないでください．チェックを入れると回収対象になった場合の挙動を選択できます．
- **サイズ**：CPUコア数やメモリ量などの組み合わせを選択します．
- **休止状態を有効にする**：選択可能な場合に休止状態を有効にしたい場合はチェックを入れてください．

#### 管理者アカウント

- **認証の種類**:：仮想マシンへのリモートログインをパスワード認証で行うか公開鍵認証で行うかを選択します．公開鍵認証ができないシステムからの自動ログインに組み込む等のやむを得ない理由がない限りは，セキュリティ上公開鍵認証を選択してください．
- **ユーザー名**：初期ログイン用のアカウント名を指定します．azureuser が初期状態で入力されていますので，必要に応じて変更してください．
- **SSH公開キーのソース**：既に持っている鍵ペアがある場合は、それを利用することも可能です．通常は新しいキーの組の生成を選択してください．
- **SSHキーの種類**：RSAかEd25519を選択できます．一般的にはEd25519の方が安全性が高いとされますが、古いシステムではRSAしか対応していない場合もあるため、そういったシステムとの連携を検討している場合はRSAを選択ください．
- **キーの組名**：作成されたSSH鍵ペアは，Azure Portal のリソースグループ内に鍵リソースとして保管されるので，そのリソース名となります．初期状態では「仮想マシン名\_key」が入力されているのでそのままで問題ありません．

#### 受信ポートの規則

- **パブリック受信ポート**：初期アクセス用にリモートからのアクセスを許可するかどうかを選択します．なしを選んだ場合は、Azure Portal内からアクセスします．
- **受信ポートを選択**：前項で「選択したポートを許可する」を選択した場合，ssh,https,http の３つのポートのどれを許可するかを選択します．

### ディスクパート

#### VMディスクの暗号化

- **ホストでの暗号化**：暗号化をすることができる構成の場合はチェックボックスが有効になりますので，選択ください．

#### OSディスク

- **OSディスクサイズ**：30GBから2TBまで８つ選択できますので，必要な容量を選択ください．データ領域が必要な場合は別途設定が可能（後述）なので、必要最小限で構いません．
- **OSディスクの種類**：SSDかHDDか、ローカルかゾーンか等を選択できます．用途に合わせて選択ください．
- **VMと共に削除**：将来何らかの理由で仮想マシンを削除する際、連動してディスクも自動削除するかどうかを選択できます．チェックを入れると，仮想マシンを削除すると自動的にOSディスク領域も削除されるので、一旦OSディスク領域は残しておきたい場合はチェックを入れないようにしてください．
- **キーの管理**：プラットフォームマネージドキーのままで問題ありません．
- **Ultra Disk の互換性を有効にする**：（確認中）

### ネットワークパート

#### ネットワークインターフェース

- **仮想ネットワーク**：ネットワークもリソースの１つとして管理されるので，そのリソース名になります．初期状態で入力されているリソース名で問題ありません．
- **サブネット**：仮想ネットワークで利用するサブネットを設定します．通常は初期状態で設定されている10.0.0.0/24 のままで問題ありませんが，変更したい場合は更新してください．サブネットの追加等は仮想マシン構成後も可能です．
- **パブリックIP**：外部とのアクセスは、別途割り当てられるグローバルIPアドレスを使った静的NATで行われます．ここではそのリソース名を設定します．初期状態のままで問題ありません．
- **NICネットワークセキュリティグループ**：仮想ホスト側とは別に，ネットワーク側で通信制限を行うかどうかを設定します．Basic を選択すると，イングレスフィルター等の基本的な制限が設定されます．
- **パブリック受信ポート**：外部からのアクセスを制限するかどうかを選択します．基本パートで設定した受信ポートの規則と基本的に同一で，マシン側で制限するか，ネットワーク側で制限するかの違いです．
- **受信ポートを選択**：前項で「選択したポートを許可する」を選択した場合，ssh,https,http の３つのポートのどれを許可する>かを選択します．こちらも基本パートで設定した同項目と同一です．
- **VMが削除されたときにパブリックIPとNICを削除する**：将来何らかの理由で仮想マシンを削除する際、連動してネットワークも自動削除するかどうかを選択できます．グローバルIPアドレスは設定するごとにランダムに割り当てられるため、仮想マシンは削除してもグローバルIPアドレスは使いまわしたい可能性がある場合はチェックを入れないでください．
- **高速ネットワークを有効にする**：（確認中）

#### 負荷分散

- **負荷分散のオプション**：複数の仮想マシンを構築し，それらをAzure の負荷分散機能を使った構成で利用したい場合は選択してください．

### 管理パート

#### ID

- **システム割り当てマネージドIDの有効化**：Azure のリソースには権限(IAM)を付与して利用しますが，仮想マシン自体に権限を付与して別のサービスを利用等する場合に，仮想マシンにIDを付与する必要があります．そのような利用が想定される場合はこのチェックを有効にしてください．

#### Microsoft Entra ID

- **Microsoft Entra ID でログイン**：(確認中)

#### 自動シャットダウン

- **自動シャットダウンを有効にする**：日時を指定して定期的なシャットダウンをする運用を検討している場合は，この項目を有効にしてください．

#### パックアップ

- **バックアップの有効化**：Azure内にバックアップを置きたい場合は有効にしてください．

#### ゲストOSの更新プログラム

- **パッチオーケストレーションオプション**：(確認中)

### 監視パート

#### アラート

- **推奨されるアラートルールを有効化**：Azureが推奨するアラートを受け取りたい場合は有効化してください．

#### 診断

- **ブート診断**：(確認中)
- **OSゲスト診断を有効にする**：OSが行う起動時のマシンチェックを有効にしたい場合はチェックを入れてください．

#### 正常性

- **アプリケーションの正常性確認を有効にする**：（確認中）

### 詳細パート

このパートは，構築実行中に実施しておきたい拡張や追加アプリ，設定項目の指定を行います．例えばＷｅｂサーバにする予定の場合，apache のパッケージをあらかじめインストールしておく設定をしたり、httpd.conf の設定や必要なユーザーアカウントの事前設定などを構築実行中に指示できます．詳細はそれぞれの項目の説明を参照ください．

### タグパート

このパートは基本的に何も設定しなくて問題ありません．

### 確認及び作成パート

ここまで設定してきた内容の確認画面が表示されますので，間違いが無ければ画面左下の「確認及び作成」ボタンをクリックしてください．

## 仮想マシンを作成する

確認及び作成をクリックすると内容の検証が始まり，検証が通ると以下が行われた後構成が始まります．

- **価格**：作成された仮想マシンのランニングコストが毎時で表示されます．想定を大きく超える場合は構成を見直してください．
- **使用条件**：使用者の名前，登録されている優先連絡先メールアドレス，登録されている優先連絡先電話番号が表示されるので，間違いないか確認ください．

上記確認の次のタイミングで，SSH鍵ペアの秘密鍵をダウンロードするかどうかの選択が表示されるので，ダウンロードしてください．基本パートで公開鍵認証を選択している場合パスワード認証は無効になっていますので，リモートから初期アクセスする場合にこの秘密鍵をつかってログインします．

デプロイが完了しましたと表示されたら作成終了です．仮想マシンリソースをクリックすると割り当てられたグローバルIPアドレスが画面右側に表示されていますので，そのIPアドレスに対してSSHログインを行いログインできたら完了です．

`ssh -i [ダウンロードした秘密鍵] azureuser@[IPアドレス]`
